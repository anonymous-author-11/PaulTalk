name: Verify Build Environment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'requirements-ci.txt'

    - name: Ensure compiler executables exist
      shell: pwsh
      run: |
        $required = @(
          "executables/mlir-opt.exe",
          "executables/mlir-translate.exe",
          "executables/llvm-link.exe",
          "executables/llvm-ar.exe",
          "executables/opt.exe",
          "executables/llc.exe",
          "executables/lld.exe",
          "executables/debugir.exe",
          "executables/standalone-opt.exe"
        )
        foreach ($path in $required) {
          if (-not (Test-Path $path)) {
            Write-Error "Missing required executable: $path"
            exit 1
          }
        }

    - name: Install Python dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        if (-not (Test-Path requirements-ci.txt)) {
          Write-Error "Missing requirements-ci.txt"
          exit 1
        }
        pip install -r requirements-ci.txt

    - name: Verify tool versions
      shell: pwsh
      run: |
        .\executables\mlir-opt.exe --version
        .\executables\mlir-translate.exe --version
        .\executables\llvm-link.exe --version
        .\executables\opt.exe --version
        .\executables\llc.exe --version
        .\executables\lld.exe -flavor link --version

    - name: Run fast test suite
      shell: pwsh
      run: |
        python tests.py --suite fast
